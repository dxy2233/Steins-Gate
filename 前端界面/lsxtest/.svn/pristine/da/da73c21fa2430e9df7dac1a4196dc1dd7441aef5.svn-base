<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/9/12
 * Time: 9:27
 */
namespace app\modules\system\controllers;


use common\models\ShopUser;
use yii\db\Query;
use yii\web\Controller;

class ShopsetController extends \seller\controllers\InitController
    {
    //    return [
    //        'class' => IsLoginController::className()
    //    ]; // TODO: Change the autogenerated stub
    //}{
    //public function behaviors()
    //{
    //    return [
    //        'class' => IsLoginController::className()
    //    ]; // TODO: Change the autogenerated stub
    //}

    public $shop_usermsg;
    public function init ()
    {
        $session = \Yii::$app->session;
        $this->shop_usermsg = $session->get('seller_msg');
    }

    public $enableCsrfValidation = false;

    public function actionIndex (){
        
        $params[] = '';
        return $this->render('index.tpl',$params);
    }

    public function actionUpdate_pwd (){
        
        if(\Yii::$app->request->isPost&&$_POST['new_password1']&&$_POST['old_password']) {
            $shop_user_msg = ShopUser::find()->where('seller_id="'.$this->shop_usermsg['seller_id'].'" and user_status=1')->asArray()->one();
            if(!$shop_user_msg) {
                echo "<script>alert('该用户不存在或已被禁用');window.location.href='update_pwd';</script>";
                die();
                //var_dump('该用户不存在或已被禁用');die();
            }
            if (getpassword($_POST['old_password'],$shop_user_msg['password'])) {
                $result = ShopUser::updateAll([
                                    'password' => setpassword($_POST['new_password1'])
                                ], [
                                    'shop_id' => $this->shop_usermsg['shop_id']
                                ]);
                if ($result) {
                    return $this->redirect(array('/shop/center/index'));
                }else{
                echo "<script>alert('密码修改失败');window.location.href='update_pwd';</script>";
                die();
                    //var_dump('密码修改失败');die();
                }
            }else{
                echo "<script>alert('旧密码错误');window.location.href='update_pwd';</script>";
                die();
                //var_dump('旧密码错误');die();
            }
            // $sure_is = ShopUser::find()->where('shop_id='.$this->shop_usermsg['shop_id'].'')->asArray()->one();
            
        }
        // ,$params
        return $this->render('update_pwd.tpl');
    }
    

    public function actionLoginout (){
        $session = \Yii::$app->session;
        $session->set('seller_id','');
        $session->set('seller_msg','');
        return $this->redirect(array('/user/login/index'));
    }

}