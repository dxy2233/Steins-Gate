<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/9/15
 * Time: 9:00
 */
namespace app\modules\banner\controllers;

use yii\web\Controller;
use common\models\Carousel;
use common\web\Upload;

class BannerController extends Controller{

    public $layout = false;

    public function __construct ($id, $module, $config = [])
    {
        $module = \Yii::$app->getModule('banner');
        parent::__construct($id, $module, $config);
    }

    public function actionIndex()
    {
        $list = Carousel::getLb();
        $page=$list['page'];
        $data=$list['data'];
        return $this->render('index.tpl',array('data'=>$data,'page'=>$page));

    }

    public function actionAdd()
    {
        if(\Yii::$app->request->isPost){
            $data = \Yii::$app->request->post();
            $model = new Carousel();
            //上传文件
            $img = '';
            if($_FILES['carousel_path']['size']){
                $img = Upload::UploadPhoto($model,'uploads/banner/','carousel_path');
                $img = str_replace('uploads/','',$img);
            }
            if(empty($data['carousel_id'])){
                //添加轮播图
                $cookie = \Yii::$app->request->cookies;
                $user_id = $cookie->getValue('user_id');
                $model->carousel_descprtion = $data['carousel_descprtion'];
                $model->class_sort = $data['class_sort'] ? $data['class_sort'] : 255;
                $model->carousel_url = $data['carousel_url'];
                $model->carousel_path = $img;
                $model->is_display = $data['is_display'];
                $model->operator_id = $user_id ? $user_id : 1;
                $model->create_time = time();
                $result = $model->insert(false);
            }else{
                $list = Carousel::getlist($data['carousel_id']);
                if(empty($list)){
                    return $this->goBack('index');
                }
                $data['operator_id'] = 1;
                $data['carousel_path'] = $img ? $img : $list['carousel_path'];
                //修改轮播图
                $result = Carousel::Carousel_update($data['carousel_id'],$data);
            }
            return $this->goBack('index');
        }
        if(\Yii::$app->request->isGet){
            $list = \Yii::$app->request->get();
            if($list){
                $data['data'] = Carousel::getlist($list['id']);
                if(empty($data['data'])){
                    throw new UserException('轮播图不存在！');
                }
                return $this->render('add.tpl',$data);
            }
        }
        $data['data'] = array(
            'carousel_descprtion'=>'',
            'carousel_url'=>'',
            'carousel_path'=>'',
            'is_display'=>1,
            'carousel_id'=>'',
            'class_sort'=>'',
        );
        return $this->render('add.tpl',$data);
    }
    
    public function actionDel(){
        if(\Yii::$app->request->isGet){
            $list = \Yii::$app->request->get();
            if($list['id']){
                $id = Carousel::getlist($list['id']);
                if(empty($id)){
                    return $this->goBack('index');
                }
                $carousel = Carousel::Carousel_delete($list['id']);
                if($carousel){
                     return $this->goBack('index');
                }
            }
       }
    }
}