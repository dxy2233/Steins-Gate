<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/9/12
 * Time: 9:27
 */
namespace app\modules\shop\controllers;

use app\modules\shop\models\ShopDo;
use common\models\Region;
use common\models\RoleAuth;
use yii\base\Exception;
use yii\web\Controller;

class ShopController extends Controller{

    public $layout = false;

    public function __construct ($id, $module, $config = [])
    {
        $module = \Yii::$app->getModule('shop');
        parent::__construct($id, $module, $config);
    }

    public function actionList(){
        $res=RoleAuth::IsAuth(2);
//        if(empty($res))
//        {
//            echo '你没有这个权限，告辞';
//            die();
//        }
//        die();
        $region_code[0]['parent_code'] = '';
        $region_code_new[0]['parent_code'] = '';
        if (\Yii::$app->request->isPost) {
            $post =posts();
//            var_dump($post);die();
            $post['region_code']=Region::city($post);
            //二级下拉的城市信息
            $region_code = Region::get_parent_code($post['s_city']);
            //三级下拉的城市信息
            $region_code_new = Region::get_parent_code($post['s_county']);
            //取出2级父代码
//        $parent_code_one = $region_code[0]['parent_code'] ? $region_code[0]['parent_code'] : '';//城市二级
            if(empty($region_code))
            {
                $parent_code_one='';
            }
            else
            {
                $parent_code_one = $region_code[0]['parent_code'];//城市二级
            }
            if(empty($region_code_new))
            {
                $parent_code_two='';
            }
            else
            {
                $parent_code_two = $region_code_new[0]['parent_code'];//城市三级
            }

//        取出3级父代码
//        $parent_code_two = $region_code_new[0]['parent_code'] ? $region_code_new[0]['parent_code'] : '';//城市三级

        }elseif (gets())
        {
            $post=gets('post');

            $post['region_code']=Region::city($post);
            //二级下拉的城市信息
            $region_code = Region::get_parent_code($post['s_city']);

            //三级下拉的城市信息
            $region_code_new = Region::get_parent_code($post['s_county']);
            if(empty($region_code))
            {
                $parent_code_one='';
            }
            else
            {
                $parent_code_one = $region_code[0]['parent_code'];//城市二级
            }
            if(empty($region_code_new))
            {
                $parent_code_two='';
            }
            else
            {
                $parent_code_two = $region_code_new[0]['parent_code'];//城市三级
            }
        }
        else{
            $post = array('shop_name'=>'','shop_status'=>'','create_time_start'=>'','create_time_end'=>'','s_province'=>'','s_city'=>'','s_county'=>'');
            $parent_code_one='';
            $parent_code_two='';
        }

        $list=['region_name'=>'全部','region_code'=>''];
        //1级必取
        $level = Region::getlist('1');//城市一级


        //取出所有二级城市
        $parent_code_one = Region::get_parent_code($parent_code_one);
        //取出所有三级城市
        $parent_code_two = Region::get_parent_code($parent_code_two);

        array_unshift($level,$list);
        array_unshift($parent_code_one,$list);
        array_unshift($parent_code_two,$list);
//        echo '<pre/>';
//        var_dump($level);die();
        $city['level']=$level;
        $city['parent_code_one']=$parent_code_one;
        $city['parent_code_two']=$parent_code_two;

        $fileter=ShopDo::ShopList($post);
        $page=$fileter['page'];
        $data=$fileter['data'];
//        var_dump($page);die();

        return $this->render('list.tpl',array('city'=>$city,'post'=>$post,'page'=>$page,'data'=>$data));


    }
    public function actionAdd()
    {

        $post=[
            's_province'=>'',
            's_city'=>'',
            's_county'=>''
        ];

        $parent_code_one=[];
        $parent_code_two=[];
        if(posts())
        {
            $post=posts();
            try{
                ShopDo::ShopValidation($post);
            }
            catch (Exception $e)
            {
                var_dump($e->getMessage());die();
            }
//            var_dump($post);die();
            $shop_id=ShopDo::ShopAdd($post);
//            var_dump($shop_id);die();
            return $this->redirect('/shop/shop/list');
        }
        $list=['region_name'=>'全部','region_code'=>''];
        //1级必取
        $level = Region::getlist('1');//城市一级

//
//        //取出所有二级城市
//        $parent_code_one = Region::get_parent_code($parent_code_one);
//        //取出所有三级城市
//        $parent_code_two = Region::get_parent_code($parent_code_two);

        array_unshift($level,$list);
        array_unshift($parent_code_one,$list);
        array_unshift($parent_code_two,$list);
//        echo '<pre/>';
//        var_dump($level);die();
        $city['level']=$level;
        $city['parent_code_one']=$parent_code_one;
        $city['parent_code_two']=$parent_code_two;
        return $this->render('add.tpl',['city'=>$city,'post'=>$post]);
    }
    public function actionInfo()
    {
        $id=gets('id');
        $data=ShopDo::ShopInfo($id);
        return $this->render('info.tpl',['data'=>$data]);
    }
    public function actionEdit()
    {
//        $post=[
//            's_province'=>'',
//            's_city'=>'',
//            's_county'=>''
//        ];
//        $parent_code_one='';
//        $parent_code_two='';
            if(posts())
            {
               $post=posts();
               $res=ShopDo::ShopEdit($post);
//               var_dump($res);die();
                return $this->redirect('/shop/shop/list');
            }
            $shop_id=gets('id');
            $data=ShopDo::ShopEditInfo($shop_id);
            $post=$data['post'];
            $arr=$data['arr'];
            $parent_code_one=$post['s_province'];
            $parent_code_two=$post['s_city'];



        $list=['region_name'=>'全部','region_code'=>''];
        //1级必取
        $level = Region::getlist('1');//城市一级
        //取出所有二级城市
        $parent_code_one = Region::get_parent_code($parent_code_one);
        //取出所有三级城市
        $parent_code_two = Region::get_parent_code($parent_code_two);
        array_unshift($level,$list);
        array_unshift($parent_code_one,$list);
        array_unshift($parent_code_two,$list);
        $city['level']=$level;
        $city['parent_code_one']=$parent_code_one;
        $city['parent_code_two']=$parent_code_two;


        return $this->render('edit.tpl',['city'=>$city,'post'=>$post,'arr'=>$arr]);
    }
    public function actionRepassword()
    {
        $shop_id =gets('id');
        $res=ShopDo::RePassword($shop_id);

        echo $res;

    }
}