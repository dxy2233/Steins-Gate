<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/9/12
 * Time: 9:27
 * 统计中心
 */
namespace app\modules\Statistics\controllers;


use common\models\BanquetOrder;
use common\models\UserOrder;
use yii\db\Query;
use yii\web\Controller;

class StatisticscenterController extends \seller\controllers\InitController
    {
    //    return [
    //        'class' => IsLoginController::className()
    //    ]; // TODO: Change the autogenerated stub
    //}{
    //public function behaviors()
    //{
    //    return [
    //        'class' => IsLoginController::className()
    //    ]; // TODO: Change the autogenerated stub
    //}
    public $enableCsrfValidation = false;
    public $shop_usermsg;
    public function init ()
    {
        $session = \Yii::$app->session;
        $this->shop_usermsg = $session->get('seller_msg');
    }
 
    public function actionIndex (){
        if($this->shop_usermsg['shop_id']){
            $statistics[] = BanquetOrder::find()->select('sum(order_price*joined_peoples) as total_moeny,count(order_id) as total_order')->where('shop_id='.$this->shop_usermsg['shop_id'].' and order_status=3')->asArray()->one();
            $statistics[] = UserOrder::find()->where('shop_id='.$this->shop_usermsg['shop_id'].' and order_status=3')->groupBy('user_id')->asArray()->count();
        }
        $params['statistics'] = $statistics;
        return $this->render('index.tpl',$params);
    }
    public function actionFindmsg (){
        if(\Yii::$app->request->isPost&&$_POST['star_time']&&$_POST['end_time']&&$this->shop_usermsg['shop_id']) 
        {
            $star_time = strtotime($_POST['star_time']);
            $end_time = strtotime($_POST['end_time']);
            $statistics[] = BanquetOrder::find()->select('sum(order_price*joined_peoples) as total_moeny,count(order_id) as total_order')->where('shop_id='.$this->shop_usermsg['shop_id'].' and order_status=3 and create_time>'.$star_time.' and create_time<'.$end_time.'')->asArray()->one();
            $statistics[] = UserOrder::find()->select('count(record_id) as total_user')->where('shop_id='.$this->shop_usermsg['shop_id'].' and order_status=3 and pay_time>'.$star_time.' and pay_time<'.$end_time.'')->groupBy('user_id')->asArray()->count();
        }
        $params['statistics'] = $statistics;
        $params['star_time'] = $star_time;
        $params['end_time'] = $end_time;
        return $this->render('findmsg.tpl',$params);
    }

}