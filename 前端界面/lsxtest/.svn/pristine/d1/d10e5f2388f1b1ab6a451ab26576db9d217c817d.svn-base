<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/9/12
 * Time: 9:27
 */
namespace app\modules\user\controllers;

use yii;
use common\models\ShopUser;
use common\models\Shop;
use yii\db\Query;
use yii\web\Controller;

class LoginController extends Controller{
    //public function behaviors()
    //{
    //    return [
    //        'class' => IsLoginController::className()
    //    ]; // TODO: Change the autogenerated stub
    //}
    public $enableCsrfValidation = false;
    public $layout = 'main.tpl';

    // public function __construct ($id, $module, $config = [])
    // {
    //     $module = \Yii::$app->getModule('user');
    //     parent::__construct($id, $module, $config);
    // }

    public function actionIndex (){
        $session = \Yii::$app->session;
        if($session->get('seller_id')) {
        //return \Yii::$app->getResponse()->redirect(Url::to(array('/user/login/index')), 302);
         Yii::$app->getSession()->setFlash('error', '您已经登录');
         return $this->redirect(array('/shop/center/index'));
        }
        // Yii::$app->request->isPost && 
        if(Yii::$app->request->isPost&&$_POST['shop_name']&&$_POST['shop_password']) 
        {
            $shop_usermsg = ShopUser::find()->where('shop_user="'.$_POST['shop_name'].'"')->asArray()->one();
            Yii::$app->response->format = \yii\web\Response::FORMAT_JSON;
            if($shop_usermsg) {
                if (!$shop_usermsg['user_status']) {
                    return ['status'=>0,'msg'=>'该账户已被停用'];
                }
                $shop_msg = Shop::find()->select('shop_status')->where('shop_id="'.$shop_usermsg['shop_id'].'"')->asArray()->one();
                if (!$shop_msg['shop_status']) {
                    return ['status'=>0,'msg'=>'该商家已被停用'];
                }
                if (getpassword($_POST['shop_password'],$shop_usermsg['password'])) {
                    
                    $session = \Yii::$app->session;
                    $session->set('seller_id',$shop_usermsg['seller_id']);
                    $session->set('seller_msg',$shop_usermsg);
                    $last_time = Shop::find()->select('last_time')->where('shop_id='.$shop_usermsg['shop_id'].'')->asArray()->one();
                    if ($last_time['last_time']) {
                        $result=['status'=>1,'msg'=>0];
                    }else{
                        $result=['status'=>1,'msg'=>1];
                    }
                    Shop::updateAll([
                                    'last_time' => time()
                                ], [
                                    'shop_id' => $shop_usermsg['shop_id']
                                ]);
                }else{
                    $result=['status'=>0,'msg'=>'密码错误'];
                }
                return $result;
            }else{
                return ['status'=>0,'msg'=>'没有该账户'];
            }
            
        }
        return $this->render('login.tpl');
    }


    public function actionBuy (){
        var_dump(111);
    }

}